<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸ”¥ Memazos Pro ðŸ”¥</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #fff;
    }
    header {
      background: #1e293b;
      padding: 20px;
      text-align: center;
      font-size: 2.5rem;
      color: #38bdf8;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      text-shadow: 2px 2px #000;
    }
    #searchContainer {
      text-align: center;
      padding: 20px;
    }
    #searchInput {
      padding: 10px;
      width: 300px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
    }
    #searchButton {
      padding: 10px 20px;
      font-size: 16px;
      background: #38bdf8;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 10px;
    }
    #uploadContainer {
      text-align: center;
      margin-top: 20px;
    }
    #gallery {
      column-count: 4;
      column-gap: 10px;
      padding: 20px;
    }
    .meme {
      margin-bottom: 10px;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .meme:hover {
      transform: scale(1.05);
    }
    .meme img {
      width: 100%;
      border-radius: 10px;
    }
    #editorModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #editorContent {
      background: #1e293b;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
    }
    #memeCanvas {
      border: 2px solid #38bdf8;
      background: #fff;
    }
    .editor-buttons {
      margin-top: 10px;
    }
    .editor-buttons button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      background: #38bdf8;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
    }
    .editor-buttons input[type="file"] {
      display: inline-block;
    }
  </style>
</head>
<body>
  <header>ðŸ”¥ Memazos Pro ðŸ”¥</header>
  <div id="searchContainer">
    <input id="searchInput" type="text" placeholder="Buscar memes o stickers..." />
    <button id="searchButton">Buscar</button>
  </div>

  <div id="uploadContainer">
    <input type="file" id="uploadInput" accept="image/*,video/gif" />
    <button onclick="uploadImage()">Subir imagen o gif</button>
  </div>

  <div id="gallery"></div>

  <div id="editorModal">
    <div id="editorContent">
      <canvas id="memeCanvas"></canvas><br />
      <div class="editor-buttons">
        <button onclick="addTextBox()">Agregar texto</button>
        <button onclick="addEmoji()">Agregar emoji</button>
        <label for="addImageInput" class="custom-file-upload">
          <button type="button">Subir sticker</button>
        </label>
        <input type="file" id="addImageInput" accept="image/*" onchange="addImageToCanvas(event)" style="display: none;" />
        <button onclick="downloadMeme()">Descargar</button>
        <button onclick="closeEditor()">Cerrar</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <script>
    const searchButton = document.getElementById("searchButton");
    const searchInput = document.getElementById("searchInput");
    const gallery = document.getElementById("gallery");
    const editorModal = document.getElementById("editorModal");

    // Instancia de Fabric.js para manejar el Canvas
    const canvas = new fabric.Canvas('memeCanvas');

    // Clave de API para Tenor. Utiliza una clave de prueba que funciona.
    const TENOR_API_KEY = "LIVDSRZULELA";

    // Variables para la "IA" simulada
    const MEMES_POR_PAGINA = 25;

    // LÃ³gica para el buscador de memes y stickers
    async function searchMemes(query) {
      gallery.innerHTML = "";
      try {
        const imgflipResponse = await fetch("https://api.imgflip.com/get_memes");
        const imgflipData = await imgflipResponse.json();
        const memes = imgflipData.data.memes.slice(0, MEMES_POR_PAGINA);

        const tenorResponse = await fetch(`https://g.tenor.com/v1/search?q=${encodeURIComponent(query)}&key=${TENOR_API_KEY}&limit=${MEMES_POR_PAGINA}`);
        const tenorData = await tenorResponse.json();
        const stickers = tenorData.results.map(r => r.media[0].gif.url);

        const allImages = [...memes.map(m => m.url), ...stickers];

        allImages.forEach(url => {
          const div = document.createElement("div");
          div.className = "meme";
          const img = document.createElement("img");
          img.src = url;
          img.loading = "lazy"; // Carga perezosa para optimizar
          img.onclick = () => openEditor(url);
          div.appendChild(img);
          gallery.appendChild(div);
        });
      } catch (error) {
        console.error("Error al buscar memes o stickers:", error);
      }
    }

    // Abre el editor de memes
    function openEditor(url) {
      editorModal.style.display = "flex";
      // Carga la imagen de fondo en el canvas con Fabric.js
      fabric.Image.fromURL(url, function(img) {
        // Redimensiona el canvas para que se ajuste a la imagen
        const scale = Math.min(600 / img.width, 400 / img.height, 1);
        canvas.setWidth(img.width * scale);
        canvas.setHeight(img.height * scale);
        
        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
          scaleX: scale,
          scaleY: scale
        });
      }, { crossOrigin: 'anonymous' });
    }

    // Cierra el editor
    function closeEditor() {
      editorModal.style.display = "none";
      canvas.clear(); // Limpia el canvas para la prÃ³xima ediciÃ³n
    }

    // Agregar texto al canvas
    function addTextBox() {
      const text = prompt("Escribe el texto:");
      if (!text) return;
      const textObject = new fabric.IText(text, {
        left: 50,
        top: 50,
        fontFamily: 'Impact',
        fontSize: 40,
        fill: '#ffffff',
        stroke: '#000000',
        strokeWidth: 2,
        // Haz el texto seleccionable y movible
        selectable: true,
        evented: true,
      });
      canvas.add(textObject);
      canvas.setActiveObject(textObject);
    }

    // Agregar emoji al canvas
    function addEmoji() {
      const emoji = prompt("Escribe un emoji:");
      if (!emoji) return;
      const emojiObject = new fabric.Text(emoji, {
        left: 50,
        top: 50,
        fontSize: 60,
        // Haz el emoji seleccionable y movible
        selectable: true,
        evented: true,
      });
      canvas.add(emojiObject);
      canvas.setActiveObject(emojiObject);
    }

    // Agregar una imagen (sticker) subida por el usuario
    function addImageToCanvas(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        fabric.Image.fromURL(e.target.result, function(img) {
          img.set({
            left: 50,
            top: 50,
            scaleX: 0.5,
            scaleY: 0.5,
            // Haz la imagen seleccionable y movible
            selectable: true,
            evented: true,
          });
          canvas.add(img);
          canvas.setActiveObject(img);
        });
      };
      reader.readAsDataURL(file);
    }

    // Carga la imagen o GIF subido por el usuario en el editor
    function uploadImage() {
      const file = document.getElementById("uploadInput").files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        openEditor(e.target.result);
      };
      reader.readAsDataURL(file);
    }

    // Descargar el meme editado
    function downloadMeme() {
      const dataURL = canvas.toDataURL({
        format: 'png',
        quality: 1,
      });
      const link = document.createElement("a");
      link.download = "memazo_editado.png";
      link.href = dataURL;
      link.click();
    }

    // Event listeners
    searchButton.addEventListener("click", () => {
      const query = searchInput.value.trim() || "memes";
      searchMemes(query);
    });

    // Carga inicial de memes
    searchMemes("memes divertidos");
  </script>
</body>
</html>